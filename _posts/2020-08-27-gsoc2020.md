---
layout: post
title: Recapping Google Summer of Code 2020
---
## Summary
[Rdkit](https://github.com/rdkit) is a cheminformatics and machine learning library. [MongoDB](https://www.mongodb.com/) is a NoSQL, document-oriented database system. This summer I built a Python package called mongordkit that marries the two, using rdkit to do chemistry and Mongo to support heterogeneous data and fast similarity and substructure search.

This post reports the work done, some things to note, and next steps. If you're interested in getting right to the code, reading up on background, or learning more about Google Summer of Code, check out the following links:

## Essential References
- [GitHub Repository](https://github.com/rdkit/mongo-rdkit) - cloning this repository gets you mongordkit and accompanying documentation. Check out the README for installation and testing details. If you want to start using the package or adding to it, this is the place to start.
- Blog posts by [Matt Swain](https://matt-swain.com/blog/2014-06-03-chemical-similarity-search-in-mongodb) and [ChEMBL](http://chembl.blogspot.com/2015/08/lsh-based-similarity-search-in-mongodb.html) - my work on similarity search implements their approaches. They deserve a shoutout and this is great background reading.
- [Project Proposal](https://drive.google.com/file/d/1hZyP3dMqYqqhio_pvqgoZvQOuCOSCMV0/view?usp=sharing) - this is the original proposal for my GSoC project. This could be of great help if you plan on pursuing a GSoC summer of your own.

## Report
### What Was Planned
A chemically intelligent MongoDB RDKit Python package with the following features:
- Rich storage of molecules. This will support a range of data types and
accompanying information.
- Generation and storage of molecular fingerprints generated by the RDKit.
- Functions that add molecules, fingerprints, and descriptive information to a database from a file.
- Functions that add molecules, fingerprints, and descriptive information to
items already in a database.
- MongoDB-optimized substructure search.
- MongoDB-optimized similarity search.
- Benchmarks and testing for all features.

### What's Been Done
<div class="message">tl;dr: all relevant planned features implemented.</div>

The Python package is called mongordkit and has two user-facing packages called `Database` and `Search`. Each is divided into modules based on functionality:
```python
mongordkit |
    Database |
        registration.py
        write.py
        tests
    Search   |
        similarity.py
        substructure.py
        tests
```

`Database` allows users to pull molecules from SDF files or Python lists of `rdmol` objects, convert them into documents, and insert them into Mongo collections along with hashes, fingerprints, and descriptive information. `Database` also provides a `MolDocScheme` object, which modifies the hashes, fingerprints, and information included as molecules are written and allows users to modify molecules already in the database.

`Search` includes the methods `SimSearchAggregate`, `SimSearchLSH`, and `SubSearch`, which efficiently perform similarity or substructure search given a query `rdmol` object. Behind the scenes, `Search` also includes many helper methods that manipulate fingerprints or hashes for efficient searching. I've bundled these into methods like `Search.PrepareForSearch`, but the helpers are nonetheless importable.

Here's a typical user story:
```python
import pymongo
from rdkit import Chem
from mongordkit import Search
from mongordkit.Database import registration, write
from mongordkit.Search import similarity, substructure

# Obtain an SDF file with relevant molecules.
ChEMBL = 'chembl_27.sdf'

# Define a molecule scheme object and modify it
# so that molecules written in include all available hashes.
mol_scheme = registration.MolDocScheme()
mol_scheme.add_all_hashes()

# Write molecules into a Mongo collection.
db = pymongo.MongoClient()
write.WriteFromSDF(db.molecules, ChEMBL, mol_scheme)

# Prepare the Mongo collection for search.
Search.PrepareForSearch(db.molecules, db.fp_counts)

# Query for molecules with a Tanimoto similarity of 0.8 or above.
query_mol = Chem.MolFromSmiles("ccO")
similarity.SimSearchAggregate(query_mol, db.molecules, db.fp_counts, 0.8)

# Query for molecules that contain "ccO" as a substructure.
substructure.SubSearch(query_mol, db.molecules)
```

A full list of methods and classes for each can be found in the [documentation](https://github.com/rdkit/mongo-rdkit/tree/master/docs/notebooks).
### Some things to note:
**On sharding**:
The original proposal called for implementation of MongoDB's sharding features in order to speed up search. The idea was that with truly large databases, their speed while searching may be limited by the server's ability to hold the entire working set.

To investigate, I took MongoDB University's M103 and M220P courses, which exposed me to cluster administration and the pymongo driver, respectively. It turned out that even though sharding impacts performance, it wasn't really in scope; how the database is sharded depends on database administrators, not the database cartridge.

**On testing and different operating systems**: Most tests in `mongordkit` are run using instances of [mongomock](https://github.com/mongomock/mongomock). Unfortunately, mongomock doesn't have aggregation pipeline functionality yet, so a few tests do require a live Mongo instance. Due to the overhead of setting up Mongo in an Azure Pipeline, the aggregation pipeline tests have not been run on Windows or Linux machines.

### Immediate Next Steps
Extra features:
1. Multi-molecule similarity or substructure search.
2. Building out identity search with tautomer insensitive options.
3. Adding extra hashes and fingerprints, eventually allowing substructure and similarity search to have multiple fingerprint options.

Optimization:
1. Multiprocessing for similarity and substructure queries.
2. Improving write times, which could be a barrier to usage.

### Conclusion
This was a deeply satisfying project. Certainly, it was a great experience to do end-to-end software development; we rarely cover CI/CD, documentation, and configuration headaches in school. I'm most grateful to Marco Stenta, Peter Gedeck, and Greg Landrum for their guidance, and Google for their financial and organizational support. But most rewarding—and I guess this is the power of open-source development—is that others will be able to use and build on what I have made. Cheers to a great summer.
